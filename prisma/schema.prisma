// Wash Novel 2.0 - Database Schema
// Using PostgreSQL for production deployment

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

// Novel processing session
model Session {
  id        String   @id @default(cuid())
  name      String
  status    String   @default("uploading") // uploading | indexing | planning | confirmed | executing | completed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Large data stored as JSONB for better query performance (legacy fields)
  chapters        Json    @default("{}")  // Record<number, Chapter>
  chapterIndex    Json    @default("[]")  // ChapterIndex[]
  planEvents      Json    @default("[]")  // EventPlan[]
  planRationale   String  @default("")
  planMode        String  @default("auto")
  planConfirmed   Boolean @default(false)
  nodes           Json    @default("{}")  // Record<number, Node>
  globalMemory    String  @default("")
  contentAnalysis Json    @default("{}")

  // [Upgrade 1] AI-normalized character mapping table
  // Example: { "叶凡": "韩立", "庞博": "厉飞雨" }
  characterMap    Json?

  // Relations
  tasks          Task[]
  chapterRecords Chapter[]
  nodeRecords    Node[]
  memoryLogs     MemoryLog[]
  rawCharacters  RawCharacterLog[]

  @@index([status])
  @@index([createdAt])
}

// Background task (BullMQ job reference)
model Task {
  id        String   @id @default(cuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  type   String // indexing | planning | generating | reviewing
  status String @default("pending") // pending | running | completed | failed | cancelled

  progress Int @default(0)
  total    Int @default(0)

  result Json?   // JSON result data
  error  String?

  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  // Context for task recovery (stores current position, model, etc.)
  context Json @default("{}")

  // BullMQ job reference
  bullJobId String?

  // Relations
  events TaskEvent[]

  @@index([sessionId])
  @@index([status])
  @@index([createdAt])
}

// Task event for SSE streaming and history
model TaskEvent {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  type    String // progress | log | error | complete | thought
  message String
  data    Json   @default("{}") // JSON additional data

  createdAt DateTime @default(now())

  @@index([taskId, createdAt])
}

// Chapter records (normalized chapters per session)
model Chapter {
  id        Int      @id @default(autoincrement())
  sessionId String
  number    Int
  title     String
  content   String   @db.Text

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, number])
  @@index([sessionId, number])
}

// Node: tree-structured narrative nodes (main line + branches)
model Node {
  id        Int      @id @default(autoincrement())
  sessionId String

  // Node type: "main" (主线), "branch_body" (支线过程), "branch_end" (支线结局)
  type       String   @default("main")
  nodeIndex  Int      // order within its line
  title      String?
  description String   @default("")
  content    String   @db.Text // final generated Markdown

  // Optional link back to original chapter range for this node
  startChapter Int?
  endChapter   Int?

  // Branching metadata
  parentId       Int?     // fork point: which node this one branched from
  returnToNodeId Int?     // convergence point for return branches
  branchReason   String?  // explanation / condition for entering this branch

  // Execution state
  status       String   @default("pending")
  qualityScore Int?

  session   Session    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  memories  MemoryLog[]

  @@index([sessionId, nodeIndex])
}

// Append-only memory log for sliding-window context
model MemoryLog {
  id        Int      @id @default(autoincrement())
  sessionId String
  nodeId    Int?     // optional: node that produced this memory

  content    String   @db.Text // memory payload
  type       String   // e.g. "summary" | "item" | "relation"
  importance Int      @default(1) // weight 1-5

  createdAt DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  node    Node?   @relation(fields: [nodeId], references: [id])

  @@index([sessionId, createdAt])
}

// Raw character appearances extracted during indexing
model RawCharacterLog {
  id            Int      @id @default(autoincrement())
  sessionId     String
  chapterNumber Int
  name          String
  role          String?
  aliases       Json?

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, name])
  @@index([sessionId, chapterNumber])
}
